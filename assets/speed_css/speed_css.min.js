class CSSUsageCollector{constructor(e=!0,t=[]){this.cacheDir="undefined"!=typeof speed_css_vars&&speed_css_vars.cache_directory?speed_css_vars.cache_directory:"acd-unused-css",this.stylesheetsCSS={},this.currentHost=window.location.host,this.logWarnings=e,this.includePatterns=t,this.totalOriginalLength=0,this.totalFilteredLength=0,this.has_collected=!1}async collect(){var e;this.has_collected=!0;for(let c of document.styleSheets)this.shouldProcessSheet(c)&&await this.processSheet(c);const t=this.getResults();if(Object.keys(t).length>0){var s=document.body.className.split(/\s+/),r=/^(rtl|home|blog|privacy-policy|archive|date|search(-[a-zA-Z0-9-_]+)?|paged|attachment|error404|[a-zA-Z0-9-__]+-template|single(-[a-zA-Z0-9-_]+)?|page(-[a-zA-Z0-9-_]+)?|post-type-archive(-[a-zA-Z0-9-_]+)?|author(-[a-zA-Z0-9-_]+)?|category(-[a-zA-Z0-9-_]+)?|tag(-[a-zA-Z0-9-_]+)?|tax(-[a-zA-Z0-9-_]+)?|term(-[a-zA-Z0-9-_]+)?)$/,o=s.filter((function(e){return r.test(e)}));this.updateConfig({css:t,url:document.location.href,post_id:(null==(e=document.body.className.split(" ").find((e=>e.startsWith("postid-")||e.startsWith("page-id-"))))?void 0:e.replace(/(postid-|page-id-)/,""))||null,post_types:o,reduction:this.calculatePercentageDifference()})}return this.stylesheetsCSS}async processSheet(e){let t="";const s=new Set;try{for(let t of e.cssRules)if(t.type===CSSRule.STYLE_RULE){const e=t.style.getPropertyValue("font-family").trim().replace(/['"]/g,"");e&&s.add(e)}}catch(r){this.warn(`Error processing stylesheet '${e.href}':`,r)}try{for(let o of e.cssRules)if(o.type===CSSRule.IMPORT_RULE){const e=o.styleSheet;e&&await this.processSheet(e)}else if(o.type===CSSRule.MEDIA_RULE){t+=`@media ${o.media.mediaText} {\n`;for(let e of o.cssRules)if(e.type===CSSRule.STYLE_RULE&&(this.shouldIncludeSelector(e.selectorText)||this.doesSelectorMatch(e))){t+=`  ${this.reconstructRule(e)}\n`}t+="}\n"}else if(o.type===CSSRule.KEYFRAMES_RULE){t+=`@keyframes ${o.name} {\n`;for(let e of o.cssRules)e.type===CSSRule.KEYFRAME_RULE&&(t+=`  ${e.keyText} { ${e.style.cssText} }\n`);t+="}\n"}else if(o.type===CSSRule.FONT_FACE_RULE){const e=o.style.getPropertyValue("font-family").trim().replace(/['"]/g,"");e&&s.has(e)&&(t+=o.cssText+"\n")}else if(o.selectorText)try{if(this.totalOriginalLength+=o.cssText.length,this.shouldIncludeSelector(o.selectorText)||this.doesSelectorMatch(o)){const e=this.reconstructRule(o);t+=e+"\n",this.totalFilteredLength+=e.length}}catch(r){this.warn(`Error testing selector '${o.selectorText}':`,r)}}catch(r){this.warn(`Error processing stylesheet '${e.href}':`,r)}e.href&&(this.stylesheetsCSS[e.href]=(this.stylesheetsCSS[e.href]||"")+t)}shouldProcessSheet(e){if(!e.href)return!1;try{const t=new URL(e.href),s="string"==typeof e.ownerNode.dataset.ucssProcessed&&"true"==e.ownerNode.dataset.ucssProcessed;return t.host===this.currentHost&&!t.pathname.includes(this.cacheDir)&&!s}catch(t){return this.warn(`Error processing stylesheet '${e.href}':`,t),!1}}reconstructRule(e){let t=e.cssText;const s=e.style;for(let r=0;r<s.length;r++){const e=s[r];if("content"===e){let r=s.getPropertyValue(e),o=this.reEscapeContent(r);t=t.replace(`content: ${r}`,`content: ${o}`)}}return t}reEscapeContent(e){return e.replace(/[\uE000-\uF8FF]/g,(function(e){return"\\"+e.charCodeAt(0).toString(16).padStart(4,"0")}))}doesSelectorMatch(e){const t=e.selectorText;try{if(":root"===t.trim())return!0;if(!this.isValidSelector(t))return this.warn(`Invalid selector: '${t}'`),!1;var s=t.replace(/:not\([^)]+\)/g,"").replace(/,\s*$/,"");const e=(s=s.replace(/:(hover|active|focus|visited|focus-within|focus-visible)/g,"")).replace(/::?[\w-]+$/,""),r=/::[\w-]+$/.test(s),o=document.querySelectorAll(e);if(0===o.length)return!1;if(!r)return!0;for(const t of o){const e=window.getComputedStyle(t,s.match(/::[\w-]+$/)[0]);if("none"!==e.content&&"none"!==e.display)return!0}return!1}catch(r){return this.warn(`Error querying selector '${t}':`,r),!1}}shouldIncludeSelector(e){return this.includePatterns.some((t=>t.test(e)))}isValidSelector(e){try{return document.createElement("div").querySelector(e),!0}catch(t){return!1}}updateConfig(e){(async()=>{try{const t=JSON.stringify(e),s=await this.compressAndBase64Encode(t),r=await fetch("/wp-json/unused-css/update_css",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({compressedData:s})}),o=await r.json();console.log("Successfully updated config:",o)}catch(t){console.error("Error updating config:",t)}})()}getResults(){return this.stylesheetsCSS}warn(...e){this.logWarnings&&console.warn(...e)}calculatePercentageDifference(){if(0===this.totalOriginalLength)return 0;return(this.totalOriginalLength-this.totalFilteredLength)/this.totalOriginalLength*100}async compressAndBase64Encode(e){const t=new Blob([e]).stream().pipeThrough(new CompressionStream("gzip")),s=[];for await(const c of t)s.push(c);const r=await this.concatUint8Arrays(s),o=String.fromCharCode(...r);return btoa(o)}async concatUint8Arrays(e){const t=new Blob(e),s=await t.arrayBuffer();return new Uint8Array(s)}collect_after_scroll(){const e=setTimeout((()=>{this.collect_when_idle()}),5e3);this.scrollListener=()=>{clearTimeout(e),clearTimeout(window.scrollIdleTimeout),window.scrollIdleTimeout=setTimeout((()=>{this.collect_when_idle()}),1e3)},window.addEventListener("scroll",this.scrollListener)}collect_when_idle(){void 0!==this.scrollListener&&window.removeEventListener("scroll",this.scrollListener),requestIdleCallback((()=>{0==this.has_collected&&this.collect()}))}}!function(){var e=JSON.parse(speed_css_vars.include_patterns);e=e.map((e=>new RegExp(e.replace(/\\\\/g,"\\"))));new CSSUsageCollector(!1,e).collect_after_scroll()}();
